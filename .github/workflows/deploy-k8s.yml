name: Deploy to Production

on:
  workflow_dispatch:

jobs:
  build-backend-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout with tag
      uses: actions/checkout@v4
      with:
          ref: ${{ github.ref_name }}

    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Build server
      run: |
        ./gradlew :server:build          

    - name: Yandex Cloud CR "Login" Action for GitHub Actions
      uses: yc-actions/yc-cr-login@v0.1-alpha
      with:
        yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}

    - name: Build and push Docker image
      env:
        CR_REGISTRY: ${{ secrets.CR_REGISTRY }}
        CR_REPOSITORY: ${{ vars.CR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |

        docker build -f ./Dockerfile \
          -t cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG .

        
        docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG
        
        # Tag and push as latest for convenience
        docker tag cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:latest
        docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:latest
  
  build-backend-mailisearch:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout with tag
      uses: actions/checkout@v4
      with:
          ref: ${{ github.ref_name }}

    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Build server
      run: |
        ./gradlew :mass-index-creator:build       

    - name: Yandex Cloud CR "Login" Action for GitHub Actions
      uses: yc-actions/yc-cr-login@v0.1-alpha
      with:
        yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}

    - name: Build and push Docker image
      env:
        CR_REGISTRY: ${{ secrets.CR_REGISTRY }}
        CR_REPOSITORY: imshaby-mass-index-creator-prod
        IMAGE_TAG: ${{ github.sha }}
      run: |

        docker build -f ./mass-index-creator/Dockerfile-job \
          -t cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG .

        
        docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG
        
        # Tag and push as latest for convenience
        docker tag cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:latest
        docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:latest

  deploy-k8s:
    runs-on: ubuntu-latest
    needs: [build-backend-mailisearch, build-backend-api]
    
    steps:
    - name: Setup Kubernetes tools
      run: |
        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        
        # Install helm
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        
        # Verify installation
        kubectl version --client
        helm version

    - name: Deploy to Production Cluster
      env:
        CR_REGISTRY: ${{ secrets.CR_REGISTRY }}
        CR_REPOSITORY: ${{ vars.CR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
        K8S_SERVER: ${{ secrets.K8S_SERVER }}
      run: |
        mkdir -p ~/.kube
        
        # Configure kubectl for Yandex Managed Kubernetes
        # 1. Set cluster configuration
        kubectl config set-cluster production \
          --server=$K8S_SERVER \
          --insecure-skip-tls-verify=true
        
        # 2. Set credentials
        kubectl config set-credentials prod-user --token="${{ secrets.PROD_K8S_TOKEN }}"
        
        # 3. Create context
        kubectl config set-context prod-context --cluster=production --user=prod-user --namespace=backend
        
        # 4. Use context
        kubectl config use-context prod-context
        
        # Deploy using Helm
        helm upgrade --install imshaby-api ./.helm \
          --set image.tag=$IMAGE_TAG \
          --set image.repository=cr.yandex/$CR_REGISTRY/$CR_REPOSITORY \
          --debug \
          --atomic \
          --timeout 8m \
          --namespace backend \
          -f ./.helm/values.yaml

        helm upgrade --install imshaby-multisearch ./.helm \
          --set workloads.multisearch.image.tag=$IMAGE_TAG \
          --set workloads.multisearch.image.repository=cr.yandex/$CR_REGISTRY/imshaby-mass-index-creator-prod \
          --debug \
          --atomic \
          --timeout 8m \
          --namespace backend \
          -f ./.helm/values.yaml
        
        # Verify deployment
        kubectl rollout status deployment/imshaby-api -n backend --timeout=300s
        kubectl rollout status deployment/imshaby-multisearch -n backend --timeout=300s
